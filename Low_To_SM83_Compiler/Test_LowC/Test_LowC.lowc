#include "../../stdlow.h"

#include "../../low_macros.h"

#include "lowc_lib.h"

#include "Test_Bricks.h"

#include "Alphabet_Tiles.h"

#define CH_Cursor_X (byte)0x00
#define CH_Cursor_Y (byte)0x01
#define CH_Tilemap_Low (byte)0x02
#define CH_Tilemap_High (byte)0x03

void Load_Graphics_Into_VRAM(byte* Write_Head, const byte* Read_Head, word Counter);	// Declares the function

void Wait_For_VBlank()
{
	byte Scanline;

	do
	{
		Scanline = *LCDY_REGISTER;
	} while (Scanline < VBLANK_SCANLINE);

	// *LCDC_REGISTER = 0;	// This turns off the screen to allow writes to VRAM

	// memcpy(VRAM_BLOCK_2, addressof(0x0104), 0x40);

	return;
}

void Load_Graphics_Into_VRAM(byte* Write_Head, const byte* Read_Head, word Counter)
{
	Write_Head = Write_Head;
	Read_Head = Read_Head;
	Counter = Counter;

	while (Counter | high(Counter))
	{
		*Write_Head = *Read_Head;
		Write_Head++;
		Read_Head++;
		Counter--;
	}

	return;
}

void init_console_handle(byte* Console_Handle)
{
	*Console_Handle = 0;
	Console_Handle++;
	*Console_Handle = 0;
	Console_Handle++;

	*Console_Handle = VRAM_TILEM_0;
	Console_Handle++;
	*Console_Handle = high(VRAM_TILEM_0);

	return;
}

void printf(byte* Console_Handle, const byte* String);

void printf(byte* Console_Handle, const byte* String)
{
	// Note that there are 32 bytes per tilemap line

	byte* Write_Pointer;

	store_low(Write_Pointer, *(Console_Handle + CH_Tilemap_Low) );
	store_high(Write_Pointer, *(Console_Handle + CH_Tilemap_High) );

	// Wait_For_Vblank();

	String = String;
	Write_Pointer = Write_Pointer;

	do
	{
		*(Write_Pointer) = *(String);
		Write_Pointer++;
		String++;
	}while(*String);

	store_low(Write_Pointer, ( 224 & (byte)Write_Pointer) );
	Write_Pointer = (Write_Pointer + (byte)32);

	*(Console_Handle + CH_Tilemap_Low) = (byte)Write_Pointer;
	*(Console_Handle + CH_Tilemap_High) = high(Write_Pointer);

	return;
}

const byte Other_Test_String[] = "ABSOLUTELY INCREDIBLE...";
const byte Hacking[] = "DONT YOU KNOW? HACKING IS A SIN";


const byte String_Table[] = {
	Other_Test_String,	high(Other_Test_String),
	Hacking,			high(Hacking)
};

void main()
{
	// This will wait until VBlank, disable the LCDC register, and then load the graphics into VRAM

	// Then it'll just enter a loop for testing sake

	Wait_For_VBlank();

	*LCDC_REGISTER = 0x00; // This turns off the PPU to allow the CPU access to VRAM

	memcpy(VRAM_BLOCK_0, Brick_Graphics, sizeof(Brick_Graphics));

	memcpy(VRAM_BLOCK_1, Alphabet_Graphics, sizeof(Alphabet_Graphics));

	byte Console_Handle[4];
	const byte Test_String[] = "HELLO! THIS IS A TEST";

	init_console_handle(Console_Handle);
	printf(Console_Handle, Test_String);
	printf(Console_Handle, Other_Test_String);
	printf(Console_Handle, Hacking);

	*LCDC_REGISTER = 0x81;	// This'll display the screen accordingly!

	word Frame_Counter;

	Frame_Counter = 0;

	do
	{
		if (!*(LCDY_REGISTER))
		{
			Frame_Counter++;

			if ((byte)Frame_Counter > 20)	// at 60FPS, this'll roughly be three times per second
			{
				*(BACKGROUND_SCROLL_X_REGISTER)++;

				Frame_Counter = 0;
			}

			do
			{
				init_dma();				// just do random busy-work (waiting)
			} while (!*(LCDY_REGISTER));
		}
	} while (1);

	return;
}

